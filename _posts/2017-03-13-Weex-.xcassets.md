---
layout: post
title: 'Weex è·å– .xcassets ä¸­çš„å›¾ç‰‡'
date: '2017-03-13'
header-img: "img/post-bg-weex.jpg"
tags:
     - Weex
     - .xcassets
author: 'MmoaaY'
---

## èƒŒæ™¯

å› ä¸º .xcassets ä¸­çš„å›¾ç‰‡èµ„æºåªèƒ½é€šè¿‡ `imageNamed:` æ–¹æ³•åŠ è½½ï¼Œæ‰€ä»¥éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†ï¼Œæ‰èƒ½æä¾›ç»™ weex ä½¿ç”¨ï¼ˆPSï¼šçº¯å±å¨±ä¹ï¼Œå› ä¸º weex è·¨å¹³å°çš„ç‰¹æ€§ï¼Œè¿™ç§é’ˆå¯¹æŸä¸€ç«¯åšå®ç°çš„æ–¹æ¡ˆå®ç”¨ä»·å€¼å¹¶ä¸å¤§ï¼‰ã€‚

## æ–¹æ¡ˆ

è§‚å¯Ÿ WeexSDK å‘ç°æœ‰ `WXImgLoaderProtocol` è¿™ä¸ªåè®®ï¼Œè¿™ä¸ªåè®®åŒ…å«äº†ä¸‹é¢çš„æ–¹æ³•ï¼š

``` objc
- (id<WXImageOperationProtocol>)downloadImageWithURL:(NSString *)url imageFrame:(CGRect)imageFrame userInfo:(NSDictionary *)options completed:(void(^)(UIImage *image,  NSError *error, BOOL finished))completedBlock;
```

ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•å£°æ˜çš„åŠŸèƒ½å°±æ˜¯é€šè¿‡æŒ‡å®šçš„ URL ä¸‹è½½å›¾ç‰‡å¹¶è¿”å›ä¸€ä¸ª `UIImage` å¯¹è±¡ã€‚

ä¸‹è½½è¿‡ WeexDemo çš„äººåº”è¯¥éƒ½çŸ¥é“é‡Œé¢æœ‰ä¸€ä¸ªå« `WXImgLoaderDefaultImpl` çš„ç±»ï¼ˆPSï¼šåˆ«å‘Šè¯‰æˆ‘ä½ å¯¹ weex æ„Ÿå…´è¶£ç¡®è¿ WeexDemo é‡Œé¢æœ‰å•¥éƒ½ä¸çŸ¥é“ï¼‰ã€‚è¿™ä¸ªç±»å®ç°äº† `WXImgLoaderProtocol` åè®®ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

``` objc
- (id<WXImageOperationProtocol>)downloadImageWithURL:(NSString *)url imageFrame:(CGRect)imageFrame userInfo:(NSDictionary *)userInfo completed:(void(^)(UIImage *image,  NSError *error, BOOL finished))completedBlock
{
    if ([url hasPrefix:@"//"]) {
        url = [@"http:" stringByAppendingString:url];
    }
    
    return (id<WXImageOperationProtocol>)[[SDWebImageManager sharedManager] downloadImageWithURL:[NSURL URLWithString:url] options:0 progress:^(NSInteger receivedSize, NSInteger expectedSize) {
        
    } completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, BOOL finished, NSURL *imageURL) {
        if (completedBlock) {
            completedBlock(image, error, finished);
        }
    }];
}
```

å…¶å®å°±æ˜¯åˆ©ç”¨ `SDWebImage` è¿™ä¸ªåº“å®ç°å›¾ç‰‡ä¸‹è½½åŠŸèƒ½ã€‚è€Œä¸”æˆ‘è¿˜å‘ç°ï¼Œå¦‚æœä¸å®ç° `WXImgLoaderProtocol` åè®®ï¼Œå°±æ— æ³•åœ¨ weex çš„ä»£ç ä¸­é€šè¿‡ URL åŠ è½½ç½‘ç»œå›¾ç‰‡ã€‚ä¹Ÿå°±æ˜¯è¯´ weex å…¶å®æ˜¯ä¾èµ–åŸç”Ÿæ¥åšç½‘ç»œå›¾ç‰‡åŠ è½½ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œæˆ‘åªèƒ½è¯´ï¼šæˆ‘ä¸çŸ¥é“ã€‚ğŸ˜‚

ç„¶å WeexDemo é€šè¿‡ä¸‹é¢çš„ä»£ç æŠŠ `WXImgLoaderDefaultImpl` æ³¨å†Œä¸º weex çš„ä¸€ä¸ª iOS åŸç”Ÿ handler

``` objc

[WXSDKEngine registerHandler:[WXImgLoaderDefaultImpl new] withProtocol:@protocol(WXImgLoaderProtocol)];

```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ weex ä¸­åŠ è½½ç½‘ç»œå›¾ç‰‡äº†ï¼Œæ¯”å¦‚ï¼š

``` html
<image class="img" style="width: 68px; height: 68px;margin-left:20px;" src="https://gw.alicdn.com/tps/TB1El.mKXXXXXXyapXXXXXXXXXX-34-34.gif"></image>
```

å¥½äº†ï¼Œç°åœ¨å°±æ¥è¯´è¯´æ€ä¹ˆåŠ è½½ .xcassets ä¸­çš„å›¾ç‰‡èµ„æºï¼Œå…¶å®å¾ˆç®€å•ï¼Œåœ¨ `WXImgLoaderDefaultImpl` å®ç°çš„æ–¹æ³•ä¸­æ·»åŠ å‡ è¡Œä»£ç å°±å¯ä»¥ï¼š

``` objc
if ([url hasPrefix:@"xcassets:"]) {
    UIImage *image = [UIImage imageNamed:[url substringFromIndex:9]];
    completedBlock(image, nil, YES);
    
    return [WXXCassetsLoaderOperation new];
}
```

è¿™é‡Œæˆ‘å®šä¹‰çš„è§„åˆ™æ˜¯ï¼šxcassets:+[.xcassets ä¸­çš„å›¾ç‰‡å]ã€‚æ‰€ä»¥æˆ‘ä»¬åˆ¤æ–­ `url` æ˜¯ä¸æ˜¯ä»¥ `xcassets:` å¼€å¤´ï¼Œå¦‚æœæ˜¯ï¼Œé€šè¿‡ `imageNamed` æ–¹æ³•åŠ è½½å›¾ç‰‡å¹¶è¿”å›å³å¯ã€‚

å› ä¸º `downloadImageWithURL` æ–¹æ³•è¦æ±‚è¿”å›éµå¾ª `WXImageOperationProtocol` åè®®çš„å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ–°å»ºä¸€ä¸ª `WXXCassetsLoaderOperation` ç±»ï¼Œç„¶åå®ç° `WXImageOperationProtocol` åè®®ä¸­çš„ `cancel` æ–¹æ³•ï¼š

``` objc
- (void)cancel {
}
```

ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨ weex ä¸­åŠ è½½ .xcassets ä¸­çš„å›¾ç‰‡äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š

``` html
<image class="img" style="width: 300px; height: 300px;" src="xcassets:reload"></image>
```



> å¦‚æœ‰ä»»ä½•çŸ¥è¯†äº§æƒã€ç‰ˆæƒé—®é¢˜æˆ–ç†è®ºé”™è¯¯ï¼Œè¿˜è¯·æŒ‡æ­£ã€‚
>
> è½¬è½½è¯·æ³¨æ˜åŸä½œè€…åŠä»¥ä¸Šä¿¡æ¯ã€‚
